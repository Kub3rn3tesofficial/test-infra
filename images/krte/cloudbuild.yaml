timeout: 1800s
steps:
  - name: gcr.io/k8s-testimages/gcb-docker-gcloud
    entrypoint: /buildx-entrypoint
    args:
      - build
      - --tag=gcr.io/$PROJECT_ID/krte:$_GIT_TAG-$_CONFIG
      - --platform=linux/$_PLATFORM
      - --build-arg=GO_VERSION=$_GO_VERSION
      - --build-arg=K8S_RELEASE=$_K8S_RELEASE
      - --build-arg=BAZEL_VERSION_ARG=$_BAZEL_VERSION
      - --build-arg=OLD_BAZEL_VERSION=$_OLD_BAZEL_VERSION
      - --build-arg=CFSSL_VERSION=$_CFSSL_VERSION
      - --build-arg=UPGRADE_DOCKER_ARG=$_UPGRADE_DOCKER
      - --build-arg=IMAGE_ARG=gcr.io/$PROJECT_ID/krte:$_GIT_TAG-$_CONFIG
      - --push
      - .
    dir: images/krte
  - name: gcr.io/k8s-testimages/gcb-docker-gcloud
    entrypoint: gcloud
    args:
      - container
      - images
      - add-tag
      - gcr.io/$PROJECT_ID/krte:$_GIT_TAG-$_CONFIG
      - gcr.io/$PROJECT_ID/krte:latest-$_CONFIG
    dir: images/krte
substitutions:
  _GIT_TAG: '12345'
  _CONFIG: master
  _GO_VERSION: 1.13.5
  _K8S_RELEASE: stable
  _BAZEL_VERSION: 3.4.1
  _OLD_BAZEL_VERSION: 2.2.0
  _UPGRADE_DOCKER: 'false'
  _CFSSL_VERSION: R1.2
  _GO_ARCH: amd64
  _PLATFORM: amd64
options:
  substitution_option: ALLOW_LOOSE
