# Prow chart 

This is a helm chart for the kubernetes [test-infra prow project](https://github.com/kubernetes/test-infra/tree/master/prow).  Prow is the internal CI system/workflow engine used for public kubernetes projects.  This is an attempt to the tool for use for other github projects.  Prow was written to run in it's own kubernetes cluster.

## Usage

This assumes a pre-created k8s cluster.

### github auth tokens

One goal of this chart was to minimize the manual steps around github auth tokens and webhooks.  It uses [hook_manager](https://github.com/jfelten/hook_manager) and scripts to genreate and install a github auth token as a secret in the kubernetes cluster.  The webhooks it uses are generated by a helm a pre-install hook and removed by a helm post-install hook upon deletion.

1. First generate a github user token and add it as a secret to the cluster:

```bash
./generate_auth_k8s.sh <MY-BOT-ACCOUNT>
<MY-BOT-ACCOUNT>'s GitHub Password:
wrote results to file: github_cred
GITHUB_AUTH_ID=99013573
GITHUB_AUTH_TOKEN=<TOKEN_VALUE>
secret "hookmanager-cred" deleted
secret "hookmanager-cred" created
```


2. Install the helm chart from the test-infra repo

```bash
cd charts/prow
helm install . --set repos={"github_org/repo1" "github_org/repo2" ...}
```

3. Clean up

When undeploying use helm and the delete_auth_k8s script provided. This script removes all hooks and auth tokens from github and the k8s cluster.

```bash
helm delete <RELEASE_NAME>
./delete_auth_k8s.sh
```

## Configuration

This chart defaults to the kubernetes production values for prow. Please configure prowDomain to a value you control, since github needs a public address or dns name for webhooks. Also make sure the repos values are also values your control.
