- publisher:
    name: e2e-publishers
    publishers:
    - claim-build
    - junit-publisher
    - log-parser
    - email-ext:
        recipients: '{recipients}'
    - gcs-uploader
- e2e_job_defaults:
    builders:
    - shell: |
        {provider-env}
        {job-env}
        {post-env}
        timeout -k {kill-timeout}m {timeout}m {runner} && rc=$? || rc=$?
        if [[ ${{rc}} -ne 0 ]]; then
            if [[ -x kubernetes/cluster/log-dump.sh && -d _artifacts ]]; then
                echo "Dumping logs for any remaining nodes"
                ./kubernetes/cluster/log-dump.sh _artifacts
            fi
        fi
        {report-rc}
    description: '{description} Test owner: {test-owner}.'
    disabled: '{obj:disable_job}'
    jenkins_node: e2e
    name: e2e_job_defaults
    properties:
    - build-discarder:
        days-to-keep: 7
    provider-env: |
      export KUBERNETES_PROVIDER="gce"
      export E2E_MIN_STARTUP_PODS="1"
      export KUBE_GCE_ZONE="us-central1-f"
      export FAIL_ON_GCP_RESOURCE_LEAK="true"
      export CLOUDSDK_CORE_PRINT_UNHANDLED_TRACEBACKS="1"
    wrappers:
    - ansicolor:
        colormap: xterm
    - timeout:
        fail: true
        timeout: '{jenkins-timeout}'
    - timestamps
    - workspace-cleanup:
        dirmatch: true
        external-deletion-command: sudo rm -rf %s
- job-template:
    builders:
    - shell: |
        {provider-env}
        {job-env}
        {post-env}
        timeout -k {kill-timeout}m {timeout}m {runner} && rc=$? || rc=$?
        if [[ ${{rc}} -ne 0 ]]; then
            if [[ -x kubernetes/cluster/log-dump.sh && -d _artifacts ]]; then
                echo "Dumping logs for any remaining nodes"
                ./kubernetes/cluster/log-dump.sh _artifacts
            fi
        fi
        {report-rc}
    description: '{description} Test owner: {test-owner}.'
    disabled: '{obj:disable_job}'
    jenkins_node: e2e
    name: e2e_job_defaults
    node: '{jenkins_node}'
    properties:
    - build-discarder:
        days-to-keep: 7
    provider-env: |
      export KUBERNETES_PROVIDER="gce"
      export E2E_MIN_STARTUP_PODS="1"
      export KUBE_GCE_ZONE="us-central1-f"
      export FAIL_ON_GCP_RESOURCE_LEAK="true"
      export CLOUDSDK_CORE_PRINT_UNHANDLED_TRACEBACKS="1"
    publishers:
    - e2e-publishers:
        recipients: '{emails}'
    - description-setter:
        regexp: KUBE_GCE_MASTER_IMAGE=(.*)
    - groovy-postbuild:
        script: |
          def gciImageMatcher = manager.getLogMatcher("KUBE_GCE_MASTER_IMAGE=(.*)")
          if(gciImageMatcher?.matches()) manager.addShortText("<b>GCI Image: " + gciImageMatcher.group(1) + "</b>", "grey", "white", "0px", "white")
          def k8sVersionMatcher = manager.getLogMatcher("Using\\spublished\\sversion\\s(.*)\\s\\(from.*")
          if(k8sVersionMatcher?.matches()) manager.addShortText("<br><b>Kubernetes version: " + k8sVersionMatcher.group(1) + "</b>", "grey", "white", "0px", "white")
    triggers:
    - reverse:
        jobs: '{trigger-job}'
        result: success
    - timed: '{cron-string}'
    wrappers:
    - ansicolor:
        colormap: xterm
    - timeout:
        fail: true
        timeout: '{jenkins-timeout}'
    - timestamps
    - workspace-cleanup:
        dirmatch: true
        external-deletion-command: sudo rm -rf %s
- project:
    emails: wonderfly@google.com,qzheng@google.com
    jobs:
    - kubernetes-e2e-gce-gci-ci-{suffix}
    name: kubernetes-e2e-gce-gci-ci-master
    suffix:
    - master:
        description: Runs all non-slow, non-serial, non-flaky, tests on GCE with GCI
          images in parallel on the master branch.
        job-env: |
          export JENKINS_GCI_IMAGE_TYPE="dev"
          export GINKGO_TEST_ARGS="--ginkgo.skip=\[Slow\]|\[Serial\]|\[Disruptive\]|\[Flaky\]|\[Feature:.+\]"
          export GINKGO_PARALLEL="y"
          export PROJECT="e2e-gce-gci-ci-master"
        timeout: 30
    - slow-master:
        description: Runs slow tests on GCE with GCI images, sequentially on the master
          branch.
        job-env: |
          export JENKINS_GCI_IMAGE_TYPE="dev"
          export GINKGO_TEST_ARGS="--ginkgo.focus=\[Slow\] \
                                   --ginkgo.skip=\[Serial\]|\[Disruptive\]|\[Flaky\]|\[Feature:.+\]"
          export GINKGO_PARALLEL="y"
          export PROJECT="e2e-gce-gci-ci-master-slow"
        timeout: 60
    - serial-master:
        description: Run [Serial], [Disruptive], tests on GCE, with GCI images.
        job-env: |
          export JENKINS_GCI_IMAGE_TYPE="dev"
          export GINKGO_TEST_ARGS="--ginkgo.focus=\[Serial\]|\[Disruptive\] \
                                   --ginkgo.skip=\[Flaky\]|\[Feature:.+\]"
          export PROJECT="e2e-gce-gci-ci-serial"
        timeout: 300
    test-owner: wonderfly@google.com
    trigger-job: kubernetes-build
- project:
    emails: wonderfly@google.com,qzheng@google.com
    jobs:
    - kubernetes-e2e-gce-gci-ci-{suffix}
    name: kubernetes-e2e-gce-gci-ci-1-2
    suffix:
    - release-1.2:
        description: Runs all non-slow, non-serial, non-flaky, tests on GCE with GCI
          images in parallel on the release-1.2 branch.
        job-env: |
          export JENKINS_PUBLISHED_VERSION="ci/latest-1.2"
          export JENKINS_GCI_IMAGE_TYPE="dev"
          export GINKGO_TEST_ARGS="--ginkgo.skip=\[Slow\]|\[Serial\]|\[Disruptive\]|\[Flaky\]|\[Feature:.+\]"
          export GINKGO_PARALLEL="y"
          export PROJECT="e2e-gce-gci-ci-1-2"
        timeout: 30
    - slow-release-1.2:
        description: Runs slow tests on GCE with GCI images, sequentially on the release-1.2
          branch.
        job-env: |
          export JENKINS_PUBLISHED_VERSION="ci/latest-1.2"
          export JENKINS_GCI_IMAGE_TYPE="dev"
          export GINKGO_TEST_ARGS="--ginkgo.focus=\[Slow\] \
                                   --ginkgo.skip=\[Serial\]|\[Disruptive\]|\[Flaky\]|\[Feature:.+\]"
          export GINKGO_PARALLEL="y"
          export PROJECT="e2e-gce-gci-ci-slow-1-2"
        timeout: 60
    - serial-release-1.2:
        description: Run [Serial], [Disruptive], tests on GCE, with GCI images, on
          the release-1.2 branch.
        job-env: |
          export JENKINS_PUBLISHED_VERSION="ci/latest-1.2"
          export JENKINS_GCI_IMAGE_TYPE="dev"
          export GINKGO_TEST_ARGS="--ginkgo.focus=\[Serial\]|\[Disruptive\] \
                                   --ginkgo.skip=\[Flaky\]|\[Feature:.+\]"
          export PROJECT="e2e-gce-gci-ci-serial-1-2"
        timeout: 300
    test-owner: wonderfly@google.com
    trigger-job: kubernetes-build-1.2
- job-template:
    builders:
    - shell: |
        {provider-env}
        {job-env}
        {post-env}
        timeout -k {kill-timeout}m {timeout}m {runner} && rc=$? || rc=$?
        if [[ ${{rc}} -ne 0 ]]; then
            if [[ -x kubernetes/cluster/log-dump.sh && -d _artifacts ]]; then
                echo "Dumping logs for any remaining nodes"
                ./kubernetes/cluster/log-dump.sh _artifacts
            fi
        fi
        {report-rc}
    description: '{description} Test owner: {test-owner}.'
    disabled: '{obj:disable_job}'
    jenkins_node: e2e
    name: e2e_job_defaults
    node: '{jenkins_node}'
    properties:
    - build-discarder:
        days-to-keep: 7
    provider-env: |
      export KUBERNETES_PROVIDER="gce"
      export E2E_MIN_STARTUP_PODS="1"
      export KUBE_GCE_ZONE="us-central1-f"
      export FAIL_ON_GCP_RESOURCE_LEAK="true"
      export CLOUDSDK_CORE_PRINT_UNHANDLED_TRACEBACKS="1"
    publishers:
    - e2e-publishers:
        recipients: '{emails}'
    - description-setter:
        regexp: KUBE_GCE_MASTER_IMAGE=(.*)
    - groovy-postbuild:
        script: |
          def gciImageMatcher = manager.getLogMatcher("KUBE_GCE_MASTER_IMAGE=(.*)")
          if(gciImageMatcher?.matches()) manager.addShortText("<b>GCI Image: " + gciImageMatcher.group(1) + "</b>", "grey", "white", "0px", "white")
          def k8sVersionMatcher = manager.getLogMatcher("Using\\spublished\\sversion\\s(.*)\\s\\(from.*")
          if(k8sVersionMatcher?.matches()) manager.addShortText("<br><b>Kubernetes version: " + k8sVersionMatcher.group(1) + "</b>", "grey", "white", "0px", "white")
    triggers:
    - timed: H H/8 * * *
    wrappers:
    - ansicolor:
        colormap: xterm
    - timeout:
        fail: true
        timeout: '{jenkins-timeout}'
    - timestamps
    - workspace-cleanup:
        dirmatch: true
        external-deletion-command: sudo rm -rf %s
- project:
    emails: wonderfly@google.com,qzheng@google.com
    jobs:
    - kubernetes-e2e-gce-gci-{suffix}
    name: kubernetes-e2e-gce-gci-dev
    suffix:
    - dev-release:
        description: Runs all non-slow, non-serial, non-flaky, tests on GCE with the
          latest GCI build and the latest k8s 1.2 release.
        job-env: |
          export JENKINS_PUBLISHED_VERSION="release/stable-1.2"
          export JENKINS_GCI_IMAGE_TYPE="dev"
          export GINKGO_TEST_ARGS="--ginkgo.skip=\[Slow\]|\[Serial\]|\[Disruptive\]|\[Flaky\]|\[Feature:.+\]"
          export GINKGO_PARALLEL="y"
          export PROJECT="k8s-e2e-gce-gci-dev"
        timeout: 30
    - dev-slow:
        description: Run slow E2E tests on GCE with the latest GCI build with the
          latest k8s 1.2 release.
        job-env: |
          export JENKINS_PUBLISHED_VERSION="release/stable-1.2"
          export JENKINS_GCI_IMAGE_TYPE="dev"
          export GINKGO_TEST_ARGS="--ginkgo.focus=\[Slow\] \
                                   --ginkgo.skip=\[Serial\]|\[Disruptive\]|\[Flaky\]|\[Feature:.+\]"
          export GINKGO_PARALLEL="y"
          export PROJECT="k8s-e2e-gce-gci-dev-slow"
        timeout: 60
    - dev-serial:
        description: Run [Serial], [Disruptive], tests on GCE, with GCI dev images
          and the latest k8s 1.2 release.
        job-env: |
          export JENKINS_PUBLISHED_VERSION="release/stable-1.2"
          export JENKINS_GCI_IMAGE_TYPE="dev"
          export GINKGO_TEST_ARGS="--ginkgo.focus=\[Serial\]|\[Disruptive\] \
                                   --ginkgo.skip=\[Flaky\]|\[Feature:.+\]"
          export PROJECT="e2e-gce-gci-dev-serial"
        timeout: 300
    test-owner: wonderfly@google.com
- project:
    emails: wonderfly@google.com,qzheng@google.com
    jobs:
    - kubernetes-e2e-gce-gci-{suffix}
    name: kubernetes-e2e-gce-gci-beta
    suffix:
    - beta-release:
        description: Runs all non-slow, non-serial, non-flaky, tests on GCE with the
          latest GCI beta build and the latest k8s 1.2 release.
        job-env: |
          export JENKINS_PUBLISHED_VERSION="release/stable-1.2"
          export JENKINS_GCI_IMAGE_TYPE="beta"
          export GINKGO_TEST_ARGS="--ginkgo.skip=\[Slow\]|\[Serial\]|\[Disruptive\]|\[Flaky\]|\[Feature:.+\]"
          export GINKGO_PARALLEL="y"
          export PROJECT="k8s-e2e-gce-gci-beta"
        timeout: 30
    - beta-slow:
        description: Run slow E2E tests on GCE with the latest GCI beta build with
          the latest k8s 1.2 release.
        job-env: |
          export JENKINS_PUBLISHED_VERSION="release/stable-1.2"
          export JENKINS_GCI_IMAGE_TYPE="beta"
          export GINKGO_TEST_ARGS="--ginkgo.focus=\[Slow\] \
                                   --ginkgo.skip=\[Serial\]|\[Disruptive\]|\[Flaky\]|\[Feature:.+\]"
          export GINKGO_PARALLEL="y"
          export PROJECT="k8s-e2e-gce-gci-beta-slow"
        timeout: 60
    - beta-serial:
        description: Run [Serial], [Disruptive], tests on GCE, with GCI beta images
          and the latest k8s 1.2 release.
        job-env: |
          export JENKINS_PUBLISHED_VERSION="release/stable-1.2"
          export JENKINS_GCI_IMAGE_TYPE="beta"
          export GINKGO_TEST_ARGS="--ginkgo.focus=\[Serial\]|\[Disruptive\] \
                                   --ginkgo.skip=\[Flaky\]|\[Feature:.+\]"
          export PROJECT="e2e-gce-gci-beta-serial"
        timeout: 300
    test-owner: wonderfly@google.com
- job-template:
    builders:
    - shell: |
        {provider-env}
        {job-env}
        {post-env}
        timeout -k {kill-timeout}m {timeout}m {runner} && rc=$? || rc=$?
        if [[ ${{rc}} -ne 0 ]]; then
            if [[ -x kubernetes/cluster/log-dump.sh && -d _artifacts ]]; then
                echo "Dumping logs for any remaining nodes"
                ./kubernetes/cluster/log-dump.sh _artifacts
            fi
        fi
        {report-rc}
    description: '{description} Test owner: {test-owner}.'
    disabled: '{obj:disable_job}'
    jenkins_node: e2e
    name: e2e_job_defaults
    node: '{jenkins_node}'
    properties:
    - build-discarder:
        days-to-keep: 7
    provider-env: |
      export KUBERNETES_PROVIDER="gce"
      export E2E_MIN_STARTUP_PODS="1"
      export KUBE_GCE_ZONE="us-central1-f"
      export FAIL_ON_GCP_RESOURCE_LEAK="true"
      export CLOUDSDK_CORE_PRINT_UNHANDLED_TRACEBACKS="1"
    publishers:
    - e2e-publishers:
        recipients: '{emails}'
    - description-setter:
        regexp: KUBE_GCE_MINION_IMAGE=(.*)
    - groovy-postbuild:
        script: |
          def gciImageMatcher = manager.getLogMatcher("KUBE_GCE_MINION_IMAGE=(.*)")
          if(gciImageMatcher?.matches()) manager.addShortText("<b>GCI Image: " + gciImageMatcher.group(1) + "</b>", "grey", "white", "0px", "white")
          def k8sVersionMatcher = manager.getLogMatcher("Using\\spublished\\sversion\\s(.*)\\s\\(from.*")
          if(k8sVersionMatcher?.matches()) manager.addShortText("<br><b>Kubernetes version: " + k8sVersionMatcher.group(1) + "</b>", "grey", "white", "0px", "white")
    triggers:
    - timed: '@daily'
    wrappers:
    - ansicolor:
        colormap: xterm
    - timeout:
        fail: true
        timeout: '{jenkins-timeout}'
    - timestamps
    - workspace-cleanup:
        dirmatch: true
        external-deletion-command: sudo rm -rf %s
- project:
    branch: release-1.1
    emails: wonderfly@google.com,qzheng@google.com
    jenkins_node: master
    job-env: ""
    jobs:
    - kubernetes-e2e-gce-gci-stable-{suffix}
    name: kubernetes-e2e-gce-gci-stable
    post-env: ""
    provider-env: ""
    runner: '{old-runner-1-1}'
    suffix:
    - release:
        description: Runs all non-slow, non-serial, non-flaky, tests on GCE with the
          latest Trusty stable build and the latest k8s 1.1 release.
        disable_job: true
        timeout: 150
    - slow:
        description: Run slow E2E tests on GCE with the latest Trusty stable build
          with the latest k8s 1.1 release.
        disable_job: true
        timeout: 270
    test-owner: wonderfly@google.com

