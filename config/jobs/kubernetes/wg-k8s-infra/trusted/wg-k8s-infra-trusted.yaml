periodics:
- name: ci-k8sio-groups
  interval: 24h
  cluster: k8s-infra-prow-build-trusted
  decorate: true
  max_concurrency: 1
  annotations:
    testgrid-dashboards: wg-k8s-infra-k8sio
    testgrid-alert-email: k8s-infra-alerts@kubernetes.io
    testgrid-num-failures-to-alert: '1'
  extra_refs:
  - org: kubernetes
    repo: k8s.io
    base_ref: main
  spec:
    serviceAccountName: gsuite-groups-manager
    containers:
    - name: groups
      image: golang:1.13
      command:
      - bash
      args:
      - -c
      - "cd groups && make run -- --confirm"
- name: ci-k8sio-audit
  interval: 6h
  cluster: k8s-infra-prow-build-trusted
  decorate: true
  max_concurrency: 1
  annotations:
    testgrid-dashboards: wg-k8s-infra-k8sio
    testgrid-alert-email: hh@ii.coop
    testgrid-num-failures-to-alert: '100'
  extra_refs:
  - org: kubernetes
    repo: k8s.io
    base_ref: main
  - org: kubernetes
    repo: test-infra
    base_ref: master
  rerun_auth_config:
    github_users:
      - hh
  spec:
    serviceAccountName: k8s-infra-gcp-auditor
    containers:
    - name: audit
      image: bash:5.1.4
      # This image doesn't have bash
      # image: golang:1.15.8-alpine3.13
      # This image doesn't appear to be used anywhere...
      # image: gcr.io/k8s-testimages/gcb-docker-gcloud:v20201130-750d12f
      command:
      - bash
      args:
      - -c
      - |
        # set -x
        # set -e
        #apk --no-cache add curl python py-crcmod libc6-compat openssh-client git gnupg docker-cli make jq
        # lib6-compat is a golang dependency
        apk --no-cache add curl git jq python3 libc6-compat
        # golang 1.15.8
        export PATH=/usr/local/go/bin:${PATH}
        curl -qL https://golang.org/dl/go1.15.8.linux-amd64.tar.gz 2>/dev/null \
          | tar xzC /usr/local
        go version
        # Maybe there is a better image with golang-1.15 + gcloud?
        export PATH=/google-cloud-sdk/bin:/workspace:${PATH}
        export CLOUDSDK_CORE_DISABLE_PROMPTS=1
        # gcloud-sdk install
        mkdir -p /workspace
        pushd /workspace
        curl -qL https://dl.google.com/dl/cloudsdk/channels/rapid/google-cloud-sdk.tar.gz 2>/dev/null \
          | tar xzC /
        gcloud components install bq gsutil
        gcloud info > /workspace/gcloud-info.txt
        gcloud version
        popd

        echo "Ensure gcloud creds are working" >&2
        gcloud config list
        echo "Running Audit Script to dump GCP configuration to yaml" >&2
        pushd ./audit
        bash ./audit-gcp.sh
        popd

        echo "Generate pr-creator binary from k/test-infra/robots" >&2
        pushd ../test-infra
        go build -o ../k8s.io/pr-creator robots/pr-creator/main.go
        popd

        echo -n "Calculate github user, name, and email from token: " >&2
        # curl https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64 \
        #   -L -o /usr/local/bin/jq && chmod +x /usr/local/bin/jq
        echo $PATH
        GH_TOKEN=$(cat /etc/github-token/token)
        GH_USER=$(curl -H "Authorization: token $GH_TOKEN" "https://api.github.com/user" 2>/dev/null | jq -r .login)
        GH_NAME=$(curl -H "Authorization: token $GH_TOKEN" "https://api.github.com/user" 2>/dev/null | jq -r .name)
        GH_EMAIL=$(curl -H "Authorization: token $GH_TOKEN" -H "X-Oauth-Scope: user:email" "https://api.github.com/user/emails" 2>/dev/null | jq -r '.[] | select( .primary == true ) | .email')
        FORK_GH_BRANCH=autoaudit-${PROW_INSTANCE_NAME:-prow}
        echo "Prepare commit for possible PR via $GH_USER" >&2
        git config user.name "${GH_NAME}"
        git config user.email "${GH_EMAIL}"
        git add --all audit
        git commit -m "audit: update as of $(date +%Y-%m-%d)"
        echo -e "Pushing commit to github.com/${GH_USER}/${FORK_GH_REPO}:..." >&2
        git push -f "https://${GH_USER}:${GH_TOKEN}@github.com/${GH_USER}/${FORK_GH_REPO}" "HEAD:${FORK_GH_BRANCH}}" 2>/dev/null

        echo "Creating PR to merge ${GH_USER}:${FORK_GH_BRANCH} into master..." >&2
        title="audit: update as of $(date +%Y-%m-%d)"
        body="Audit Updates\n/wg k8s-infra"
        ./pr-creator --help || true
        ./pr-creator \
          --github-token-path=/etc/github-token/token \
          --org=kubernetes --repo=k8s.io --branch=main \
          --source="${GH_USER}:${FORK_GH_BRANCH}" \
          --head-branch="${FORK_GH_BRANCH}" \
          --title="${title}" \
          --body="${body}" \
          --confirm
      volumeMounts:
      - name: github
        mountPath: /etc/github-token
        readOnly: true
    volumes:
    - name: github
      secret:
        secretName: cncf-ci-github-token

postsubmits:
  kubernetes/k8s.io:
  - name: post-k8sio-groups
    cluster: k8s-infra-prow-build-trusted
    decorate: true
    max_concurrency: 1
    run_if_changed: '^groups/groups.yaml'
    branches:
    - ^main$
    - ^master$
    annotations:
      testgrid-create-test-group: 'true'
      testgrid-dashboards: wg-k8s-infra-k8sio
      testgrid-alert-email: k8s-infra-alerts@kubernetes.io
      testgrid-num-failures-to-alert: '1'
    spec:
      serviceAccountName: gsuite-groups-manager
      containers:
      - name: groups
        image: golang:1.13
        command:
        - bash
        args:
        - -c
        - "cd groups && make run -- --confirm"
  - name: post-k8sio-dns-update
    cluster: k8s-infra-prow-build-trusted
    decorate: true
    max_concurrency: 1
    run_if_changed: "^dns/zone-configs/"
    branches:
    - ^main$
    - ^master$
    annotations:
      testgrid-create-test-group: 'true'
      testgrid-dashboards: wg-k8s-infra-k8sio
      testgrid-alert-email: k8s-infra-alerts@kubernetes.io
      testgrid-num-failures-to-alert: '1'
    spec:
      serviceAccountName: k8s-infra-dns-updater
      containers:
      - image: us.gcr.io/k8s-artifacts-prod/infra-tools/octodns:v20200616-67ce585
        command:
        - bash
        args:
        - -c
        - "cd dns && make push-local"
  - name: post-k8sio-deploy-prow-build-resources
    cluster: k8s-infra-prow-build-trusted
    decorate: true
    max_concurrency: 1
    run_if_changed: "^infra/gcp/clusters/projects/k8s-infra-prow-build/prow-build/resources/"
    branches:
    - ^main$
    - ^master$
    annotations:
      testgrid-create-test-group: 'true'
      testgrid-dashboards: wg-k8s-infra-k8sio
      testgrid-alert-email: k8s-infra-alerts@kubernetes.io
      testgrid-num-failures-to-alert: '1'
    spec:
      serviceAccountName: prow-deployer
      containers:
      - image: gcr.io/k8s-testimages/gcloud-in-go:v20200824-5d057db
        command:
        - bash
        args:
        - -c
        - |
          gcloud container clusters get-credentials prow-build --project=k8s-infra-prow-build --region=us-central1
          kubectl --context=gke_k8s-infra-prow-build_us-central1_prow-build \
            apply -f ./infra/gcp/clusters/projects/k8s-infra-prow-build/prow-build/resources
  - name: post-k8sio-deploy-prow-build-trusted-resources
    cluster: k8s-infra-prow-build-trusted
    decorate: true
    max_concurrency: 1
    run_if_changed: "^infra/gcp/clusters/projects/k8s-infra-prow-build-trusted/prow-build-trusted/resources/"
    branches:
    - ^main$
    - ^master$
    annotations:
      testgrid-create-test-group: 'true'
      testgrid-dashboards: wg-k8s-infra-k8sio
      testgrid-alert-email: k8s-infra-alerts@kubernetes.io
      testgrid-num-failures-to-alert: '1'
    spec:
      serviceAccountName: prow-deployer
      containers:
      - image: gcr.io/k8s-testimages/gcloud-in-go:v20200824-5d057db
        command:
        - bash
        args:
        - -c
        - |
          gcloud container clusters get-credentials prow-build-trusted --project=k8s-infra-prow-build-trusted --region=us-central1
          kubectl --context=gke_k8s-infra-prow-build-trusted_us-central1_prow-build-trusted \
            apply -f ./infra/gcp/clusters/projects/k8s-infra-prow-build-trusted/prow-build-trusted/resources
