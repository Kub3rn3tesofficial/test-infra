# Currently maintained manually.
#
# The goal is to move it into k8s-staging-sig-storage.yaml
# and have these periodic jobs also generated by k8s-staging-sig-storage-gen.sh.

periodics:
# Currently only specified for the "master" branch which produces the "canary"
# images. We'll also need it for those release branches which support cloud build.
- name: canary-csi-driver-host-path-push-images
  cluster: k8s-infra-prow-build-trusted
  annotations:
    testgrid-dashboards: sig-storage-image-build
  decorate: true
  interval: 168h # one week
  extra_refs:
    # This also becomes the current directory for run.sh and thus
    # the cloud image build.
    - org: kubernetes-csi
      repo: csi-driver-host-path
      base_ref: master
  spec:
    serviceAccountName: gcb-builder
    containers:
      - image: gcr.io/k8s-testimages/image-builder:v20200901-ab141a0
        command:
          - /run.sh
        env:
        # We need to emulate a pull job for the cloud build to work the same
        # way as it usually does.
        - name: PULL_BASE_REF
          value: master
        args:
          # this is the project GCB will run in, which is the same as the GCR
          # images are pushed to.
          - --project=k8s-staging-sig-storage
          # This is the same as above, but with -gcb appended.
          - --scratch-bucket=gs://k8s-staging-sig-storage-gcb
          - --env-passthrough=PULL_BASE_REF
          - .
